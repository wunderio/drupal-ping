#!/bin/bash

set -xeuo pipefail
export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin

# must be different between branches
# it allows easy branch switching
# without need for rebuild
app="/app"
proj="$app/drupal"
webroot="$proj/web"
sites="$webroot/sites"
default="$sites/default"

set +e
rm -rf "$proj"
chmod -R 777 "$proj"
rm -rf "$proj"
set -e

# NB! When Composer breaks:
# https://www.drupal.org/project/drupal/issues/3255749
cd "$app"
composer create-project drupal/recommended-project "$proj"

chmod 755 "$default"
rm -f "$default/settings.php"
ln -s "$app/settings.php" "$default/"
ln -s "$app/_ping.custom.php" "$webroot/"
ln -s "$app/_ping.php" "$webroot/"
chmod 644 "$app/settings.php"

cd "$proj"
composer require --dev drush/drush
# @todo: Lock Code Quality atm because phpstan is failing.
# It's related to installing https://github.com/phpstan/extension-installer in Code Quality 2.4.0. Because it now loads
# phpstan extensions automatically, it starts do more scans with extensions like like mglaman/phpstan-drupal and
# phpstan/phpstan-deprecation-rules.
composer require 'wunderio/code-quality:2.3.0' --dev
composer require 'phpunit/phpunit:^9' --dev
